<%- include('./template/header'); -%>

    <div class="row">
        <div class="col-lg-6">

        </div>
        <div class="col-lg-6">
            <div class="col-lg-12">
                <div class="card shadow-sm mb-3">
                    <div class="card-body pb-0">
                        <div class="row">
                            <div class="col-xxl-8 mb-3 me-4">
                                <div class="input me-2">
                                    <input type="text" id="rfid" name="rfid" class="form-control " placeholder="RFID " aria-label="rfid ">
                                </div>
                            </div>

                            <div class="col-xxl-3 mb-3 text-end">
                                <button class="btn btn-warning w-100" id="searchRfid" type="button" disabled><i class="fas fa-key me-2 "></i>RFID</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row ">
        <div class="col-lg-12 ">
            <div class="card shadow-sm " style="min-height: 400px; ">
                <div class="card-body ">
                    <table class="table table-striped " id="table_id">
                        <thead class="table-navy-blue ">
                            <tr>
                                <th class="text-center ">รหัส RFID</th>
                                <th class="text-center ">S/N</th>
                                <th class="text-center ">เลขครุภัณฑ์</th>
                                <th class="text-center ">ชื่อครุภัณฑ์</th>
                                <th class="text-center ">ยี่ห้อ</th>
                                <th class="text-center ">รุ่น</th>
                            </tr>
                        </thead>
                        <tbody>

                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <%- include('./template/footer'); -%>

        <script>
            var Feature = (function() {
                var user = '<%- JSON.stringify(udt) %>';
                var user_data = JSON.parse(user);
                console.log("user_id" +
                    user_data["id"]);
                console.log(user);
                var today = new Date();
                var date = today.getFullYear() + '-' + (today.getMonth() + 1) + '-' + today.getDate();
                var time = today.getHours() + ":" + today.getMinutes() + ":" + today.getSeconds();
                var dateTime = date + " " + time;
                console.log(dateTime);
                var dataTable = $('#table_id').DataTable({
                    searching: false,
                    responsive: true,
                    ordering: false,
                    lengthChange: false,
                    iDisplayLength: 10,
                    bAutoWidth: false,
                    columns: [{
                        data: function(data) {
                            return data['rfid'];

                        },
                        className: 'text-center',
                    }, {
                        data: function(data) {
                            return data['serial_number'];
                        },
                        className: 'text-center',
                    }, {
                        data: function(data) {
                            return data['equipment_number'];
                        },
                        className: 'text-center',
                    }, {
                        data: function(data) {
                            return data['equipment_name'];
                        },
                        className: 'text-center',
                    }, {
                        data: function(data) {
                            return data['brand'];
                        },
                        className: 'text-center',
                    }, {
                        data: function(data) {
                            return data['model'];
                        },
                        className: 'text-center',
                    }, ],
                    serverSide: true,
                    ajaxSource: '/department/PostEquipDmp',
                    serverData: function(sSource, aaData, fnCallback, oSettings) {
                        aaData.push({
                            "name": "rfid",
                            "value": user_data["id"]
                        });
                        aaData.push({
                            "name": "dpmID",
                            "value": user_data["id"]
                        });
                        aaData.push({
                            "name": "datetime",
                            "value": dateTime
                        });
                        oSettings.jqXHR = $.ajax({
                            dataType: 'json',
                            type: "POST",
                            url: sSource,
                            data: aaData,
                            success: function(response) {
                                console.log(response);
                                console.log(response);
                                if (response.status === "Succeed") {
                                    var response = response.data;
                                    response = {
                                        "aaData": response,
                                        "iTotalRecords": response.length,
                                        "iTotalDisplayRecords": response.length
                                    };
                                } else {

                                    response = {
                                        "aaData": [],
                                        "iTotalRecords": 0,
                                        "iTotalDisplayRecords": 0
                                    };

                                }
                                fnCallback(response);

                            }
                        });
                    },
                    createdRow: function(row, data, index) {}
                });

                return {
                    initInput: function() {
                        $("#rfid").keyup(function(e) {
                            if (e.target.value.length == 10) {
                                var rfid_data = $("#rfid").val();
                                var url = '/department/PostEquipDmp';
                                $.ajax({
                                        type: 'POST',
                                        url: url,
                                        data: {
                                            rfid: rfid_data,
                                            dpmID: user_data["id"],
                                            datetime: dateTime

                                        }
                                    })
                                    .done(function(response) {
                                        if (response["status"] == "Succeed") {
                                            console.log(response);
                                            window.location = '/department';
                                        } else if (response["status"] == "Failed") {
                                            if (response["data"] == "Incorrect username") {
                                                Swal.fire({
                                                    title: "ไม่สามารถเข้าสู่ระบบได้",
                                                    text: "ชื่อผู้ใช้ของท่านไม่ถูกต้อง กรุณาลองใหม่อีกครั้ง ",
                                                    icon: "warning "
                                                });
                                            } else if (response["data"] == "Incorrect password") {
                                                Swal.fire({
                                                    title: "ไม่สามารถเข้าสู่ระบบได้ ",
                                                    text: "รหัสผ่านของท่านไม่ถูกต้อง กรุณาลองใหม่อีกครั้ง ",
                                                    icon: "warning "
                                                });
                                            }

                                        }
                                    })
                            }
                        });
                    },
                    searchData: function() {
                        $('#search').on('click', function(e) {
                            var textSearch = $('#idSearch').val();
                            if (textSearch != "") {
                                window.location = '/section?search=' + textSearch;
                            } else {
                                console.log("field null!!");
                            }
                        });
                    },
                    init: function() {
                        Feature.searchData();
                        Feature.initInput();
                    }
                }
            })();

            jQuery(document).ready(function() {
                Feature.init();
            });
        </script>